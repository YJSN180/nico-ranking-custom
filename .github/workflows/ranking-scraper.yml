name: Ranking Scraper

on:
  schedule:
    # æ¯æ™‚5åˆ†ã«å®Ÿè¡Œï¼ˆãƒ©ãƒ³ã‚­ãƒ³ã‚°æ›´æ–°é…å»¶ã‚’è€ƒæ…®ï¼‰
    - cron: '5 * * * *'
  workflow_dispatch:

jobs:
  scrape:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      
      - name: Record Start Time
        id: start_time
        run: echo "start=$(date +%s)" >> $GITHUB_OUTPUT
      
      - name: Scrape Rankings
        id: scrape
        run: |
          START_TIME=$(date +%s)
          node scripts/github-action-scraper.js
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))
          echo "duration=$DURATION" >> $GITHUB_OUTPUT
        env:
          KV_REST_API_URL: ${{ secrets.KV_REST_API_URL }}
          KV_REST_API_TOKEN: ${{ secrets.KV_REST_API_TOKEN }}
      
      - name: Update Execution Stats
        if: always()
        run: |
          # å®Ÿè¡Œçµ±è¨ˆã‚’JSONãƒ•ã‚¡ã‚¤ãƒ«ã«è¨˜éŒ²
          STATS_FILE="execution-stats.json"
          DURATION=${{ steps.scrape.outputs.duration || 0 }}
          DATE=$(date -u +"%Y-%m-%d")
          HOUR=$(date -u +"%H")
          
          # æ—¢å­˜ã®çµ±è¨ˆã‚’èª­ã¿è¾¼ã‚€ã‹æ–°è¦ä½œæˆ
          if [ -f "$STATS_FILE" ]; then
            cp $STATS_FILE $STATS_FILE.tmp
          else
            echo '{"daily": {}, "hourly": {}, "total": {"count": 0, "totalSeconds": 0}}' > $STATS_FILE.tmp
          fi
          
          # Node.jsã§çµ±è¨ˆã‚’æ›´æ–°
          node -e "
          const fs = require('fs');
          const stats = JSON.parse(fs.readFileSync('$STATS_FILE.tmp'));
          
          // æ—¥åˆ¥çµ±è¨ˆ
          if (!stats.daily['$DATE']) {
            stats.daily['$DATE'] = { count: 0, totalSeconds: 0, runs: [] };
          }
          stats.daily['$DATE'].count++;
          stats.daily['$DATE'].totalSeconds += $DURATION;
          stats.daily['$DATE'].runs.push({
            time: new Date().toISOString(),
            duration: $DURATION
          });
          
          // æ™‚é–“å¸¯åˆ¥çµ±è¨ˆ
          if (!stats.hourly['$HOUR']) {
            stats.hourly['$HOUR'] = { count: 0, totalSeconds: 0, avgSeconds: 0 };
          }
          stats.hourly['$HOUR'].count++;
          stats.hourly['$HOUR'].totalSeconds += $DURATION;
          stats.hourly['$HOUR'].avgSeconds = stats.hourly['$HOUR'].totalSeconds / stats.hourly['$HOUR'].count;
          
          // ç·åˆçµ±è¨ˆ
          stats.total.count++;
          stats.total.totalSeconds += $DURATION;
          stats.total.avgSeconds = stats.total.totalSeconds / stats.total.count;
          
          // å¤ã„ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ï¼ˆ30æ—¥ä»¥ä¸Šå‰ï¼‰
          const cutoffDate = new Date();
          cutoffDate.setDate(cutoffDate.getDate() - 30);
          const cutoffStr = cutoffDate.toISOString().split('T')[0];
          
          Object.keys(stats.daily).forEach(date => {
            if (date < cutoffStr) delete stats.daily[date];
          });
          
          fs.writeFileSync('$STATS_FILE', JSON.stringify(stats, null, 2));
          
          // ã‚µãƒãƒªãƒ¼ã‚’å‡ºåŠ›
          console.log('ğŸ“Š å®Ÿè¡Œçµ±è¨ˆæ›´æ–°å®Œäº†');
          console.log('ä»Šå›ã®å®Ÿè¡Œæ™‚é–“:', $DURATION, 'ç§’');
          console.log('æœ¬æ—¥ã®å¹³å‡:', Math.round(stats.daily['$DATE'].totalSeconds / stats.daily['$DATE'].count), 'ç§’');
          console.log('å…¨ä½“ã®å¹³å‡:', Math.round(stats.total.avgSeconds), 'ç§’');
          "
          
      - name: Generate Stats Report
        if: always()
        run: |
          # çµ±è¨ˆãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆ
          node -e "
          const fs = require('fs');
          const stats = JSON.parse(fs.readFileSync('execution-stats.json'));
          
          // æœˆé–“ä½¿ç”¨æ™‚é–“ã‚’è¨ˆç®—
          let monthlySeconds = 0;
          const thisMonth = new Date().toISOString().substring(0, 7);
          Object.entries(stats.daily).forEach(([date, data]) => {
            if (date.startsWith(thisMonth)) {
              monthlySeconds += data.totalSeconds;
            }
          });
          
          const monthlyMinutes = Math.round(monthlySeconds / 60);
          const projectedMinutes = Math.round((monthlyMinutes / new Date().getDate()) * 30);
          
          console.log('\\nğŸ“ˆ GitHub Actionsä½¿ç”¨çŠ¶æ³ãƒ¬ãƒãƒ¼ãƒˆ');
          console.log('================================');
          console.log('ä»Šæœˆã®ä½¿ç”¨æ™‚é–“:', monthlyMinutes, 'åˆ†');
          console.log('äºˆæ¸¬æœˆé–“ä½¿ç”¨æ™‚é–“:', projectedMinutes, 'åˆ† / 2000åˆ†');
          console.log('ä½¿ç”¨ç‡:', Math.round(projectedMinutes / 2000 * 100) + '%');
          
          if (projectedMinutes < 1000) {
            console.log('\\nâœ… ä½™è£•ãŒã‚ã‚Šã¾ã™ã€‚æ¯æ™‚2å›å®Ÿè¡Œã¸ã®ç§»è¡Œã‚’æ¤œè¨ã§ãã¾ã™ã€‚');
          } else if (projectedMinutes < 1500) {
            console.log('\\nâš ï¸ ç¾çŠ¶ç¶­æŒã‚’æ¨å¥¨ã—ã¾ã™ã€‚');
          } else {
            console.log('\\nğŸš¨ ä½¿ç”¨é‡ãŒå¤šã„ã§ã™ã€‚æœ€é©åŒ–ãŒå¿…è¦ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚');
          }
          "
      
      - name: Commit Stats
        if: always()
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add execution-stats.json || true
          git commit -m "Update execution stats [skip ci]" || true
          git push || true