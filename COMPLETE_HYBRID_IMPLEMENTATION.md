# 完全ハイブリッドスクレイピング実装

## 概要
本実装は、ニコニコ動画のランキングからすべての動画（センシティブ・デバイス制限動画を含む）を取得し、完全な情報（投稿者情報、メタデータ）を提供します。

## アーキテクチャ

### 3層構造のデータ取得
1. **nvAPI** - 基本データとリッチなメタデータ
2. **HTMLスクレイピング** - 全動画リスト（センシティブ動画含む）
3. **Snapshot API + 個別nvAPI** - 不足データの補完

### 処理フロー

```
1. nvAPIでランキング取得
   ├─ タグフィルタあり → そのまま返す（高速）
   └─ タグフィルタなし → ステップ2へ

2. HTMLスクレイピングで全動画取得
   └─ 動画ID、順位、基本情報を抽出

3. データマージ
   ├─ nvAPIにある動画 → nvAPIのリッチデータを使用
   └─ nvAPIにない動画 → Snapshot APIで補完

4. 投稿者情報の補完
   └─ 不足している投稿者名・アイコンを個別取得
```

## 実装詳細

### ファイル構成
- `/lib/complete-hybrid-scraper.ts` - メイン実装
- `/lib/scraper.ts` - 既存APIとの互換性レイヤー
- `/lib/scraper.ts.backup` - 元の実装のバックアップ

### 主要関数

#### `completeHybridScrape(genre, term, tag?)`
メインエントリポイント。すべての処理を統括。

#### `fetchFromNvapi(genre, term, tag?)`
nvAPIからランキングデータを取得。投稿者情報も含む。

#### `scrapeFromHTML(genre, term)`
HTMLページをスクレイピング。センシティブ動画も取得可能。

#### `mergeAllData(htmlItems, nvapiItems, nvapiMap)`
HTMLの順序を基準に、nvAPIのリッチデータをマージ。

#### `enrichAuthorInfo(items)`
不足している投稿者情報（名前、アイコン）を個別に取得。

## パフォーマンス

### 処理時間の目安
- **タグフィルタあり**: 300-500ms（nvAPIのみ）
- **タグフィルタなし**: 1000-3000ms（ハイブリッド）
  - nvAPI: 300ms
  - HTML: 400ms
  - Snapshot: 300ms
  - 投稿者情報: 100ms × 必要数

### 最適化
- レート制限管理（60req/分）
- バッチ処理（Snapshot API）
- 投稿者IDでグループ化して重複を削減

## メリット

1. **完全性** - すべての動画を取得（センシティブ含む）
2. **情報の豊富さ** - 投稿者情報、メタデータ完備
3. **互換性** - 既存のAPIインターフェース維持
4. **柔軟性** - タグフィルタ時は高速処理

## デメリット

1. **処理時間** - 最大3秒程度かかる場合がある
2. **複雑性** - 3つのデータソースを組み合わせる
3. **依存性** - HTMLの構造変更に影響される

## エラーハンドリング

- 各ステップでエラーをキャッチ
- 部分的な失敗でも可能な限りデータを返す
- 投稿者情報取得の失敗は無視（基本情報は保持）

## テスト

### ユニットテスト
```bash
npm test -- complete-hybrid-scraper.test.ts
```

### 統合テスト
```bash
# APIエンドポイント経由
curl http://localhost:3000/api/test-scraping/complete-hybrid
```

## 今後の改善案

1. **キャッシング**
   - 投稿者情報のキャッシュ
   - HTMLスクレイピング結果の短期キャッシュ

2. **並列処理**
   - nvAPIとHTMLを同時取得
   - Promise.allSettledで部分的失敗に対応

3. **監視**
   - センシティブ動画の検出率
   - 処理時間のモニタリング

## ロールバック手順

問題が発生した場合：
```bash
# バックアップから復元
cp lib/scraper.ts.backup lib/scraper.ts
```

## 結論

本実装により、RSSフィード廃止後もすべてのランキング動画を取得可能になりました。投稿者情報を含む完全なデータを提供しつつ、パフォーマンスも実用的な範囲に収まっています。