#!/usr/bin/env tsx

// HTML„Éö„Éº„Ç∏„Åã„ÇâÁõ¥Êé•„É©„É≥„Ç≠„É≥„Ç∞„Éá„Éº„Çø„ÇíÊäΩÂá∫

async function extractFromHtmlPages() {
  console.log('=== HTML„Éö„Éº„Ç∏„Åã„Çâ„É©„É≥„Ç≠„É≥„Ç∞„Éá„Éº„ÇøÊäΩÂá∫ ===')
  
  const fullHeaders = {
    'User-Agent': 'Mozilla/5.0 (iPhone; CPU iPhone OS 16_6 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/16.6 Mobile/15E148 Safari/604.1',
    'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8',
    'Accept-Language': 'ja,en-US;q=0.9,en;q=0.8',
    'Accept-Encoding': 'gzip, deflate, br, zstd',
    'Referer': 'https://sp.nicovideo.jp/',
    'Cookie': 'nicosid=1725186023.265332462; _ss_pp_id=2d36063cde9e940bcf21725153625674; _yjsu_yjad=1725186026.a31135ca-301e-4f44-aab2-ebfcf7ff867f; _id5_uid=ID5-5c99Wsu2SS8KuOtp39Cc13xhSy8xFDSzzAq-JgGQ9A; _tt_enable_cookie=1; rpr_opted_in=1; rpr_uid=204eb3b0-8c91-11ef-b6ea-69ffc2d6a68c; rpr_is_first_session={%22204eb3b0-8c91-11ef-b6ea-69ffc2d6a68c%22:1}; rpr_session_started_at=1729174041194; rpr_event_last_tracked_at=1729174041873; user_session=user_session_134077750_2da2315c5d1f49d1246ce0a83cc9519e18ab79a9bab91f27463f5dca8d10641a; user_session_secure=MTM0MDc3NzUwOlROZDFSSE1sdm9GLWouaXotV3RTbEVHYlU3M0I4eTM4QUpsVGVGcDRaRE0; lang=ja-jp; area=JP; _ttp=on9NPOyKGsihlDV2IepgZa8Cjdr.tt.1; experimentalNicoliveColorTheme=light; __eoi=ID=a832e02020c5267d:T=1740844182:RT=1745570905:S=AA-AfjaVdxRz3KhFVUc1fv-bKrV_; dlive_bid=dlive_bid_nwTL9LSbsgwRQsMekAohwYuZgJt2jP5k; nico_gc=tg_s%3Dn%26tg_o%3Dd%26srch_s%3Dv%26srch_o%3Dd; _td=5d217bdf-14ac-4916-b2da-6ae7b4ec3738; common-header-oshirasebox-new-allival=false; lastViewedRanking=%7B%22type%22%3A%22featured-key%22%2C%22featuredKey%22%3A%22d2um7mc4%22%2C%22term%22%3A%2224h%22%7D'
  }
  
  const genres = [
    { 
      name: '„Åù„ÅÆ‰ªñ', 
      id: 'ramuboyn',
      url: 'https://sp.nicovideo.jp/ranking/genre/ramuboyn?redirected=1'
    },
    { 
      name: '‰æã„ÅÆ„ÇΩ„É¨', 
      id: 'd2um7mc4',
      url: 'https://sp.nicovideo.jp/ranking/genre/d2um7mc4?redirected=1'
    }
  ]
  
  const genreResults: any = {}
  
  // ÂêÑ„Ç∏„É£„É≥„É´„ÅÆHTML„Éö„Éº„Ç∏„Åã„Çâ„Éá„Éº„ÇøÊäΩÂá∫
  for (const genre of genres) {
    console.log(`\n${'='.repeat(50)}`)
    console.log(`=== ${genre.name}„Ç∏„É£„É≥„É´ (${genre.id}) ===`)
    console.log(`${'='.repeat(50)}`)
    console.log(`URL: ${genre.url}`)
    
    try {
      const response = await fetch('http://localhost:8888/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-API-Key': 'test-key',
        },
        body: JSON.stringify({
          url: genre.url,
          headers: fullHeaders
        }),
      })

      const proxyData = await response.json()
      console.log(`HTTP Status: ${proxyData.status}`)
      
      if (proxyData.status === 200) {
        const html = proxyData.body
        console.log(`HTML„Çµ„Ç§„Ç∫: ${html.length.toLocaleString()}ÊñáÂ≠ó`)
        
        // meta tag„Åã„Çâ„É©„É≥„Ç≠„É≥„Ç∞„Éá„Éº„Çø„ÇíÊäΩÂá∫
        const metaMatch = html.match(/<meta name="server-response" content="([^"]+)"/)
        if (metaMatch) {
          console.log(`‚úÖ meta tag„ÇíÁô∫Ë¶ã`)
          
          try {
            const encodedData = metaMatch[1]
            const decodedData = encodedData
              .replace(/&quot;/g, '"')
              .replace(/&amp;/g, '&')
            
            const jsonData = JSON.parse(decodedData)
            console.log('JSONÊßãÈÄ†:', Object.keys(jsonData))
            
            if (jsonData.data?.response) {
              console.log('responseÊßãÈÄ†:', Object.keys(jsonData.data.response))
              
              // „É©„É≥„Ç≠„É≥„Ç∞„Éá„Éº„Çø„ÇíÊé¢„Åô
              const rankingData = jsonData.data.response.$getTeibanRanking?.data
              
              if (rankingData && rankingData.items) {
                console.log(`‚úÖ ${genre.name}„Ç∏„É£„É≥„É´ „É©„É≥„Ç≠„É≥„Ç∞„Éá„Éº„ÇøÂèñÂæóÊàêÂäü`)
                console.log(`  „Ç∏„É£„É≥„É´: ${rankingData.label}`)
                console.log(`  „Éï„Ç£„Éº„ÉÅ„É£„Éº„Ç≠„Éº: ${rankingData.featuredKey}`)
                console.log(`  ÂãïÁîªÊï∞: ${rankingData.items.length}`)
                console.log(`  „Çø„Ç∞Ë®≠ÂÆö: ${rankingData.tag || '„Å™„Åó'}`)
                
                // ÂãïÁîª„Çµ„É≥„Éó„É´Ë°®Á§∫
                console.log(`\nüì∫ ${genre.name}„Ç∏„É£„É≥„É´ „Çµ„É≥„Éó„É´ÂãïÁîª TOP 5:`)
                rankingData.items.slice(0, 5).forEach((item: any, index: number) => {
                  console.log(`  ${index + 1}‰Ωç: ${item.title}`)
                  console.log(`    ÂÜçÁîüÊï∞: ${item.count?.view?.toLocaleString() || '‰∏çÊòé'}Âõû`)
                  console.log(`    ÊäïÁ®øËÄÖ: ${item.owner?.name || '‰∏çÊòé'}`)
                  console.log(`    ID: ${item.id}`)
                })
                
                // „Çø„Ç∞ÂàÜÊûê
                const tagCounts: any = {}
                rankingData.items.forEach((item: any) => {
                  if (item.tags && Array.isArray(item.tags)) {
                    item.tags.forEach((tag: any) => {
                      const tagName = tag.name || tag
                      if (tagName && typeof tagName === 'string' && tagName.length > 0 && tagName.length < 25) {
                        tagCounts[tagName] = (tagCounts[tagName] || 0) + 1
                      }
                    })
                  }
                })
                
                // ‰∫∫Ê∞ó„Çø„Ç∞„Éà„ÉÉ„Éó10
                const popularTags = Object.entries(tagCounts)
                  .sort(([,a], [,b]) => (b as number) - (a as number))
                  .slice(0, 10)
                  .map(([tag, count]) => ({ tag, count }))
                
                console.log(`\nüìä ${genre.name}„Ç∏„É£„É≥„É´ ‰∫∫Ê∞ó„Çø„Ç∞ TOP 10:`)
                popularTags.forEach((item: any, index) => {
                  console.log(`  ${index + 1}. ${item.tag} (${item.count}ÂõûÂá∫Áèæ)`)
                })
                
                genreResults[genre.id] = {
                  name: genre.name,
                  popularTags: popularTags,
                  selectedTag: popularTags[0]?.tag || null,
                  rankingData: rankingData,
                  totalVideos: rankingData.items.length
                }
                
                console.log(`\nüéØ ÈÅ∏Êäû„Çø„Ç∞: „Äå${popularTags[0]?.tag || '„Å™„Åó'}„Äç`)
                
              } else {
                console.log(`‚úó ${genre.name}„Ç∏„É£„É≥„É´: „É©„É≥„Ç≠„É≥„Ç∞„Éá„Éº„Çø„Å™„Åó`)
                console.log('responseÂÜÖ„ÅÆ„Ç≠„Éº:', Object.keys(jsonData.data.response))
              }
              
              // ‰∫∫Ê∞ó„Çø„Ç∞Â∞ÇÁî®„Éá„Éº„Çø„ÇÇÊé¢„Åô
              const featuredKeysData = jsonData.data.response.$getTeibanRankingFeaturedKeys?.data
              if (featuredKeysData?.items) {
                console.log(`\nüè∑Ô∏è ${genre.name}„Ç∏„É£„É≥„É´ ‰∫∫Ê∞ó„Çø„Ç∞„É™„Çπ„Éà (${featuredKeysData.items.length}ÂÄã):`)
                featuredKeysData.items.slice(0, 10).forEach((item: any, index: number) => {
                  console.log(`  ${index + 1}. ${item.label} (featuredKey: ${item.featuredKey})`)
                })
              }
            }
            
          } catch (parseError) {
            console.log(`‚úó ${genre.name}„Ç∏„É£„É≥„É´: JSONËß£Êûê„Ç®„É©„Éº`)
            console.error(parseError)
          }
          
        } else {
          console.log(`‚úó ${genre.name}„Ç∏„É£„É≥„É´: meta tag„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì`)
        }
        
      } else {
        console.log(`‚úó ${genre.name}„Ç∏„É£„É≥„É´: HTMLÂèñÂæóÂ§±Êïó ${proxyData.status}`)
        console.log('„Ç®„É©„Éº:', proxyData.body.substring(0, 200))
      }
      
    } catch (error) {
      console.error(`${genre.name}„Ç∏„É£„É≥„É´ „Ç®„É©„Éº:`, error)
    }
    
    await new Promise(resolve => setTimeout(resolve, 1000))
  }
  
  // „Çø„Ç∞Âà•„É©„É≥„Ç≠„É≥„Ç∞ÂèñÂæó
  console.log(`\n${'='.repeat(80)}`)
  console.log('=== „Çø„Ç∞Âà•„É©„É≥„Ç≠„É≥„Ç∞ÂèñÂæó ===')
  console.log(`${'='.repeat(80)}`)
  
  for (const genreId of Object.keys(genreResults)) {
    const genreInfo = genreResults[genreId]
    const selectedTag = genreInfo.selectedTag
    
    if (!selectedTag) {
      console.log(`\n‚ùå ${genreInfo.name}„Ç∏„É£„É≥„É´: ÈÅ∏ÊäûÂèØËÉΩ„Å™„Çø„Ç∞„Å™„Åó`)
      continue
    }
    
    console.log(`\nüèÜ ${genreInfo.name}„Ç∏„É£„É≥„É´„Äå${selectedTag}„Äç„Çø„Ç∞„É©„É≥„Ç≠„É≥„Ç∞`)
    console.log(`${'‚îÄ'.repeat(60)}`)
    
    try {
      // „Çø„Ç∞Âà•„Éö„Éº„Ç∏„ÅÆURL
      const tagPageUrl = `https://sp.nicovideo.jp/ranking/genre/${genreId}?tag=${encodeURIComponent(selectedTag)}&redirected=1`
      console.log(`URL: ${tagPageUrl}`)
      
      const response = await fetch('http://localhost:8888/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-API-Key': 'test-key',
        },
        body: JSON.stringify({
          url: tagPageUrl,
          headers: fullHeaders
        }),
      })

      const proxyData = await response.json()
      
      if (proxyData.status === 200) {
        const html = proxyData.body
        
        // meta tag„Åã„Çâ„Çø„Ç∞Âà•„É©„É≥„Ç≠„É≥„Ç∞„Éá„Éº„Çø„ÇíÊäΩÂá∫
        const metaMatch = html.match(/<meta name="server-response" content="([^"]+)"/)
        if (metaMatch) {
          try {
            const encodedData = metaMatch[1]
            const decodedData = encodedData
              .replace(/&quot;/g, '"')
              .replace(/&amp;/g, '&')
            
            const jsonData = JSON.parse(decodedData)
            const tagRankingData = jsonData.data?.response?.$getTeibanRanking?.data
            
            if (tagRankingData && tagRankingData.items) {
              console.log(`‚úÖ „Äå${selectedTag}„Äç„Çø„Ç∞„É©„É≥„Ç≠„É≥„Ç∞ÂèñÂæóÊàêÂäü`)
              console.log(`  ÂãïÁîªÊï∞: ${tagRankingData.items.length}`)
              console.log(`  „Çø„Ç∞Á¢∫Ë™ç: ${tagRankingData.tag || '„Å™„Åó'}`)
              
              console.log(`\nü•á ${genreInfo.name}„Ç∏„É£„É≥„É´„Äå${selectedTag}„ÄçTOP 10:`)
              
              tagRankingData.items.slice(0, 10).forEach((item: any, index: number) => {
                console.log(`\n${index + 1}‰Ωç: ${item.title}`)
                console.log(`  ÂãïÁîªID: ${item.id}`)
                console.log(`  ÂÜçÁîüÊï∞: ${item.count?.view?.toLocaleString() || '‰∏çÊòé'}Âõû`)
                console.log(`  „Ç≥„É°„É≥„Éà: ${item.count?.comment?.toLocaleString() || '‰∏çÊòé'}‰ª∂`)
                console.log(`  ÊäïÁ®øËÄÖ: ${item.owner?.name || '‰∏çÊòé'}`)
                console.log(`  ÊäïÁ®øÊó•: ${item.registeredAt || '‰∏çÊòé'}`)
                console.log(`  URL: https://www.nicovideo.jp/watch/${item.id}`)
                
                if (item.tags && item.tags.length > 0) {
                  const tagNames = item.tags.map((tag: any) => tag.name || tag).slice(0, 5)
                  console.log(`  „Çø„Ç∞: ${tagNames.join(', ')}`)
                }
              })
              
            } else {
              console.log(`‚úó „Äå${selectedTag}„Äç„Çø„Ç∞: „Éá„Éº„Çø„Å™„Åó`)
            }
            
          } catch (parseError) {
            console.log(`‚úó „Äå${selectedTag}„Äç„Çø„Ç∞: JSONËß£Êûê„Ç®„É©„Éº`)
          }
          
        } else {
          console.log(`‚úó „Äå${selectedTag}„Äç„Çø„Ç∞: meta tag„Å™„Åó`)
        }
        
      } else {
        console.log(`‚úó „Äå${selectedTag}„Äç„Çø„Ç∞„Éö„Éº„Ç∏ÂèñÂæóÂ§±Êïó: ${proxyData.status}`)
      }
      
    } catch (error) {
      console.error(`„Äå${selectedTag}„Äç„Çø„Ç∞„Ç®„É©„Éº:`, error)
    }
    
    await new Promise(resolve => setTimeout(resolve, 1000))
  }
  
  // ÊúÄÁµÇ„Çµ„Éû„É™„Éº
  console.log(`\n${'='.repeat(80)}`)
  console.log('=== ÊúÄÁµÇÁµêÊûú„Çµ„Éû„É™„Éº ===')
  console.log(`${'='.repeat(80)}`)
  
  Object.values(genreResults).forEach((genre: any) => {
    console.log(`\nüìÇ ${genre.name}„Ç∏„É£„É≥„É´:`)
    console.log(`  Á∑èÂãïÁîªÊï∞: ${genre.totalVideos}`)
    console.log(`  ÈÅ∏Êäû„Çø„Ç∞: „Äå${genre.selectedTag}„Äç`)
    console.log(`  ‰∫∫Ê∞ó„Çø„Ç∞Êï∞: ${genre.popularTags?.length || 0}`)
    
    if (genre.popularTags && genre.popularTags.length > 0) {
      const top5 = genre.popularTags.slice(0, 5).map((tag: any) => `${tag.tag}(${tag.count})`)
      console.log(`  „Éà„ÉÉ„Éó5„Çø„Ç∞: ${top5.join(', ')}`)
    }
  })
  
  console.log(`\nüéØ HTML„Éö„Éº„Ç∏„Åã„ÇâÁõ¥Êé•„Éá„Éº„ÇøÊäΩÂá∫„Å´„Çà„Çä„ÄÅ‰∏°„Ç∏„É£„É≥„É´„ÅÆË©≥Á¥∞ÊÉÖÂ†±ÂèñÂæóÂÆå‰∫Ü`)
}

extractFromHtmlPages().catch(console.error)