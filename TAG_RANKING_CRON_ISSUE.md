# タグ別ランキング300件取得問題の調査結果

## 問題の概要
「その他」ジャンルの人気タグ別ランキングが300件取得できるはずなのに、実際にはオンデマンドで100件ずつしか取得されていない。

## 根本原因
**GitHub Actionsに移行した際に、タグ別ランキングの事前生成処理が失われた**

### 詳細
1. **Vercel Cron（無効化済み）**
   - `app/api/cron/fetch/route.ts`には「その他」ジャンルの人気タグ別ランキングを300件事前生成する処理がある（131-204行目）
   - しかし、このcronジョブは現在無効化されている（コメントアウト済み）

2. **GitHub Actions（現在使用中）**
   - `.github/workflows/update-ranking.yml`が30分ごとに実行
   - `lib/update-ranking.ts`を呼び出すが、**タグ別ランキングの事前生成処理が含まれていない**

3. **現在の動作**
   - ジャンルごとのランキングのみ事前キャッシュ
   - タグ別ランキングはすべてオンデマンド取得（100件ずつ）

## テスト結果
「田所浩治(佐倉市)」タグでテストした結果：
- ページ1: 100件取得
- ページ2: 44件取得
- **合計: 144件のみ存在**（300件は存在しない）

つまり、このタグに関しては144件が実際の上限であり、300件取得できないのは正常。

## 解決策
`lib/update-ranking.ts`に「その他」ジャンルの人気タグ別ランキングを事前生成する処理を追加しました。

### 変更内容
```typescript
// 「その他」ジャンルのすべての人気タグを両期間で事前生成
if (genre === 'other' && popularTags && popularTags.length > 0) {
  // タグ別ランキングを300件まで取得してKVに保存
  // キー: ranking-${genre}-${period}-tag-${encodeURIComponent(tag)}
}
```

## 今後の対応
1. **GitHub Actionsの次回実行時**から、「その他」ジャンルの人気タグ別ランキングが事前生成される
2. 各タグで最大300件（または存在する全件）がKVにキャッシュされる
3. クライアント側は引き続き100件ずつ取得するが、KVから高速に取得可能

## 手動実行方法
1. **GitHub Actions経由**
   ```bash
   npm run update:kv
   ```

2. **旧Vercel Cron経由**（デバッグ用）
   ```bash
   npx tsx scripts/manual-trigger-cron.ts
   ```

## 注意事項
- 一部のタグは300件に満たない場合がある（例：「田所浩治(佐倉市)」は144件）
- これは正常な動作であり、存在する分だけキャッシュされる